var mainApp=angular.module("mainApp",["firebase","angular.filter"]);mainApp.run(function(a){a._=_,a.moment=moment,a.mc=mc}),mainApp.controller("MainCtrl",["$scope","$timeout","$interval","GemFactory","CardFactory","MethodFactory","FirebaseFactory",function(a,b,c,d,e,f,g){"use strict";function h(){window.$s=a}function i(a,b){b=b||"",_.extend(this,{id:a+b,name:a,gem:a})}function j(a){_.extend(this,a,{name:a.gem,points:a.points||0,cost:_.extend(_.clone(z),a.cost)})}function k(a){_.extend(this,a,{cost:_.extend(_.clone(z),a.cost)})}function l(b){_.extend(this,{name:b,auto:!0,chips:[],cards:[],tiles:[],reserve:[],index:a.allPlayers.length})}function m(){var b=moment().format(y);_.extend(a.currentUser,{createdDate:b,name:a.authData.facebook.displayName,rating:1200,uid:a.authData.uid,gender:a.authData.facebook.cachedUserProfile.gender,firstName:a.authData.facebook.cachedUserProfile.first_name,lastName:a.authData.facebook.cachedUserProfile.last_name,picture:a.authData.facebook.cachedUserProfile.picture.data.url,timezone:a.authData.facebook.cachedUserProfile.timezone})}function n(){var a=[],b={};return _.each(e.allCards,function(b){a.push(new j(b))}),b.track1=_.shuffle(_.where(a,{track:1})),b.track2=_.shuffle(_.where(a,{track:2})),b.track3=_.shuffle(_.where(a,{track:3})),b}function o(b){a.activeCards[b].push(a.allCards[b].splice(0,1)[0])}function p(b){var c="track"+b.track;a.activeCards[c]=_.reject(a.activeCards[c],b),o(c)}function q(){var a=[];return _.each(e.allTiles,function(b){a.push(new k(b))}),_.shuffle(a)}function r(){a.activeTiles.push(a.allTiles.splice(0,1)[0])}function s(b){_.each(a.allGems,function(c){"gold"!==c.name&&a.allChips.push(new i(c.name,b))})}function t(){for(var b=1;5>=b;b++)a.allChips.push(new i("gold",b))}function u(b){var c,d,e,f,g,h=_.clone(a.currentPlayer.chips),i=!0,j=[];return _.each(b.cost,function(b,k){if(i)if(c=_.where(a.currentPlayer.cards,{name:k}).length,d=_.where(h,{name:k}).length,e=_.where(h,{name:"gold"}).length,f=b-c,f>d+e)i=!1;else{for(f;f>0&&d>0;f--)g=_.find(h,{name:k}),h=_.reject(h,{id:g.id}),j.push(g),d--;for(f;f>0;f--)g=_.find(h,{name:"gold"}),h=_.reject(h,{id:g.id}),j.push(g)}}),i&&(a.currentPlayer.chips=h,_.each(j,function(b){a.allChips.push(b)})),i}function v(b){var c,d=!0;return _.each(b.cost,function(b,e){d&&(c=_.where(a.currentPlayer.cards,{name:e}).length,d=c>=b)}),d}function w(b){var c=("track"+b.track,_.find(a.allChips,{name:"gold"}));return a.currentPlayer.reserve.length>2?(alert("You can't reserve more than 3 cards"),!1):(a.currentPlayer.reserve.push(b),p(b),delete a.currentPlayer.reservation,c&&(a.allChips=_.reject(a.allChips,{id:c.id}),a.currentPlayer.chips.push(c)),!0)}function x(b){var c=b?"Would you like to reserve this card?":"Please choose a card to reserve",d=a.currentPlayer.reservation||confirm(c);if(d){if(b)return w(b);a.currentPlayer.reservation=!0}return d||b||a.clearSelection(),d}var y="YYYY-MM-DD HH:mm:ss",z={diamond:0,sapphire:0,emerald:0,ruby:0,onyx:0},A=g.getFBObject("cursor");A.$bindTo(a,"cursor"),_.assign(a,{time:moment().format(y),allPlayers:[],allChips:[],allGems:d.allGems,gameStatus:"pre-game",ff:{newPlayerName:""},currentSelection:[],allCards:n(),allTiles:q(),activeTiles:[],activeCards:{track1:[],track2:[],track3:[]},cursor:{left:0,top:0}}),a.toggleReserve=function(a){a.showReserve=!a.showReserve},a.calculatePoints=function(a){var b=_.reduce(a.cards,function(a,b){return a+b.points},0);return _.reduce(a.tiles,function(a,b){return a+b.points},b)},a.fbLogin=function(){a.authData=g.facebookLogin(),a.currentUser=g.getFBObject("users/"+authData.uId),a.currentUser.uid||m()},a.addNewPlayer=function(){a.currentPlayer=new l(a.ff.newPlayerName),a.allPlayers.push(a.currentPlayer),a.ff.newPlayerName=""},a.changeCurrentPlayer=function(b){var c=a.currentPlayer.index+1;c===a.allPlayers.length&&(c=0),a.currentPlayer=b||_.find(a.allPlayers,{index:c})},a.startGame=function(){for(var b=4===a.allPlayers.length?7:a.allPlayers.length+2,c=1;3>=c;c++)for(var d=1;4>=d;d++)o("track"+c);for(var e=0;e<=a.allPlayers.length;e++)r();for(var f=1;b>=f;f++)s(f);t(),a.gameStatus="game-started"},a.quickStart=function(){a.ff.newPlayerName="Joey",a.addNewPlayer(),a.ff.newPlayerName="Chandler",a.addNewPlayer(),a.ff.newPlayerName="Ross",a.addNewPlayer(),a.startGame()},a.collectReserveCard=function(b,c){a.currentPlayer.name==b.name&&a.collectCard(c)},a.collectCard=function(b){var c=a.currentPlayer.reservation;if((c||!a.currentPlayer.auto)&&(c=x(b)),!c&&u(b))a.currentPlayer.cards.push(b),p(b);else if(!c&&!x(b))return!1;a.currentSelection=[],a.changeCurrentPlayer()},a.collectTile=function(b){v(b)&&(a.currentPlayer.tiles.push(b),a.activeTiles=_.reject(a.activeTiles,b))},a.collectChips=function(){var b;_.each(a.currentSelection,function(c){b=_.find(a.allChips,{name:c}),a.allChips=_.reject(a.allChips,{id:b.id}),a.currentPlayer.chips.push(b)}),a.changeCurrentPlayer(),a.currentSelection=[]},a.clearSelection=function(){a.currentSelection=[],delete a.currentPlayer.reservation},a.addChip=function(b){"gold"===b?a.currentPlayer.reserve.length<3?x():alert("You already have 3 cards, you may not reserve another"):a.currentSelection.push(_.clone(b))},a.gemAvailable=function(b){var c=_.where(a.allChips,{name:b}).length;switch(!0){case-1!==a.currentSelection.indexOf("gold")&&a.currentPlayer.reserve.length<3:return!1;case a.currentSelection.length&&a.currentSelection[0]===a.currentSelection[1]:return!1;case a.currentSelection.length&&a.currentSelection[0].name===b&&4>c:return!1;case 3===a.currentSelection.length:return!1;case-1!==a.currentSelection.indexOf(b)&&2===a.currentSelection.length:return!1;case 0!==a.currentSelection.length&&"gold"===b:return!1}return c>0},a.howMany=function(b){return _.where(a.allChips,{name:b}).length},a.moveCursor=function(b){a.cursor.left=b.pageX+2+"px",a.cursor.top=b.pageY+2+"px"},h()}]),mainApp.factory("CardFactory",[function(){"use strict";return{allCards:[{id:"S11",track:1,gem:"sapphire",cost:{ruby:4},points:1},{id:"S12",track:1,gem:"sapphire",cost:{sapphire:1,emerald:3,ruby:1}},{id:"S13",track:1,gem:"sapphire",cost:{onyx:3}},{id:"S14",track:1,gem:"sapphire",cost:{diamond:1,emerald:2,ruby:2}},{id:"S15",track:1,gem:"sapphire",cost:{emerald:2,onyx:2}},{id:"S16",track:1,gem:"sapphire",cost:{diamond:1,emerald:1,ruby:2,onyx:1}},{id:"S17",track:1,gem:"sapphire",cost:{diamond:1,onyx:2}},{id:"S18",track:1,gem:"sapphire",cost:{diamond:1,emerald:1,ruby:1,onyx:1}},{id:"O11",track:1,gem:"onyx",cost:{sapphire:4},points:1},{id:"O12",track:1,gem:"onyx",cost:{emerald:1,ruby:3,onyx:1}},{id:"O13",track:1,gem:"onyx",cost:{emerald:3}},{id:"O14",track:1,gem:"onyx",cost:{diamond:2,sapphire:2,ruby:1}},{id:"O15",track:1,gem:"onyx",cost:{diamond:2,emerald:2}},{id:"O16",track:1,gem:"onyx",cost:{diamond:1,sapphire:2,emerald:1,ruby:1}},{id:"O17",track:1,gem:"onyx",cost:{emerald:2,ruby:1}},{id:"O18",track:1,gem:"onyx",cost:{diamond:1,sapphire:1,emerald:1,ruby:1}},{id:"E11",track:1,gem:"emerald",cost:{onyx:4},points:1},{id:"E12",track:1,gem:"emerald",cost:{diamond:1,sapphire:3,emerald:1}},{id:"E13",track:1,gem:"emerald",cost:{ruby:3}},{id:"E14",track:1,gem:"emerald",cost:{sapphire:1,ruby:2,onyx:2}},{id:"E15",track:1,gem:"emerald",cost:{sapphire:2,ruby:2}},{id:"E16",track:1,gem:"emerald",cost:{diamond:1,sapphire:1,ruby:1,onyx:2}},{id:"E17",track:1,gem:"emerald",cost:{diamond:2,sapphire:1}},{id:"E18",track:1,gem:"emerald",cost:{diamond:1,sapphire:1,ruby:1,onyx:1}},{id:"R11",track:1,gem:"ruby",cost:{diamond:4},points:1},{id:"R12",track:1,gem:"ruby",cost:{diamond:1,ruby:1,onyx:3}},{id:"R13",track:1,gem:"ruby",cost:{diamond:3}},{id:"R14",track:1,gem:"ruby",cost:{diamond:2,emerald:1,onyx:2}},{id:"R15",track:1,gem:"ruby",cost:{diamond:2,ruby:2}},{id:"R16",track:1,gem:"ruby",cost:{diamond:2,sapphire:1,emerald:1,onyx:1}},{id:"R17",track:1,gem:"ruby",cost:{sapphire:2,emerald:1}},{id:"R18",track:1,gem:"ruby",cost:{diamond:1,sapphire:1,emerald:1,onyx:1}},{id:"D11",track:1,gem:"diamond",cost:{emerald:4},points:1},{id:"D12",track:1,gem:"diamond",cost:{diamond:3,sapphire:1,onyx:1}},{id:"D13",track:1,gem:"diamond",cost:{sapphire:3}},{id:"D14",track:1,gem:"diamond",cost:{sapphire:2,emerald:2,onyx:1}},{id:"D15",track:1,gem:"diamond",cost:{sapphire:2,onyx:2}},{id:"D16",track:1,gem:"diamond",cost:{sapphire:1,emerald:2,ruby:1,onyx:1}},{id:"D17",track:1,gem:"diamond",cost:{ruby:2,onyx:1}},{id:"D18",track:1,gem:"diamond",cost:{sapphire:1,emerald:1,ruby:1,onyx:1}},{id:"S21",track:2,gem:"sapphire",cost:{sapphire:6},points:3},{id:"S22",track:2,gem:"sapphire",cost:{diamond:5,sapphire:3},points:2},{id:"S23",track:2,gem:"sapphire",cost:{sapphire:5},points:2},{id:"S24",track:2,gem:"sapphire",cost:{diamond:2,ruby:1,onyx:4},points:2},{id:"S25",track:2,gem:"sapphire",cost:{sapphire:2,emerald:3,onyx:3},points:1},{id:"S26",track:2,gem:"sapphire",cost:{sapphire:2,emerald:2,ruby:3},points:1},{id:"O21",track:2,gem:"onyx",cost:{onyx:6},points:3},{id:"O22",track:2,gem:"onyx",cost:{emerald:5,ruby:3},points:2},{id:"O23",track:2,gem:"onyx",cost:{diamond:5},points:2},{id:"O24",track:2,gem:"onyx",cost:{sapphire:1,emerald:4,ruby:2},points:2},{id:"O25",track:2,gem:"onyx",cost:{diamond:3,emerald:3,onyx:2},points:1},{id:"O26",track:2,gem:"onyx",cost:{diamond:3,sapphire:2,emerald:2},points:1},{id:"E21",track:2,gem:"emerald",cost:{emerald:6},points:3},{id:"E22",track:2,gem:"emerald",cost:{sapphire:5,emerald:3},points:2},{id:"E23",track:2,gem:"emerald",cost:{emerald:5},points:2},{id:"E24",track:2,gem:"emerald",cost:{diamond:4,sapphire:2,onyx:1},points:2},{id:"E25",track:2,gem:"emerald",cost:{diamond:3,emerald:2,ruby:3},points:1},{id:"E26",track:2,gem:"emerald",cost:{diamond:2,sapphire:3,onyx:2},points:1},{id:"R21",track:2,gem:"ruby",cost:{ruby:6},points:3},{id:"R22",track:2,gem:"ruby",cost:{diamond:3,onyx:5},points:2},{id:"R23",track:2,gem:"ruby",cost:{onyx:5},points:2},{id:"R24",track:2,gem:"ruby",cost:{diamond:1,sapphire:4,emerald:2},points:2},{id:"R25",track:2,gem:"ruby",cost:{sapphire:3,ruby:2,onyx:3},points:1},{id:"R26",track:2,gem:"ruby",cost:{diamond:2,ruby:2,onyx:3},points:1},{id:"D21",track:2,gem:"diamond",cost:{diamond:6},points:3},{id:"D22",track:2,gem:"diamond",cost:{ruby:5,onyx:3},points:2},{id:"D23",track:2,gem:"diamond",cost:{ruby:5},points:2},{id:"D24",track:2,gem:"diamond",cost:{emerald:1,ruby:4,onyx:2},points:2},{id:"D25",track:2,gem:"diamond",cost:{diamond:2,sapphire:3,ruby:3},points:1},{id:"D26",track:2,gem:"diamond",cost:{emerald:3,ruby:2,onyx:2},points:1},{id:"S31",track:3,gem:"sapphire",cost:{diamond:7,sapphire:3},points:5},{id:"S32",track:3,gem:"sapphire",cost:{diamond:7},points:4},{id:"S33",track:3,gem:"sapphire",cost:{diamond:6,sapphire:3,onyx:3},points:4},{id:"S34",track:3,gem:"sapphire",cost:{diamond:3,emerald:3,ruby:3,onyx:5},points:3},{id:"O31",track:3,gem:"onyx",cost:{ruby:7,onyx:3},points:5},{id:"O32",track:3,gem:"onyx",cost:{ruby:7},points:4},{id:"O33",track:3,gem:"onyx",cost:{emerald:3,ruby:6,onyx:3},points:4},{id:"O34",track:3,gem:"onyx",cost:{diamond:3,sapphire:3,emerald:5,ruby:3},points:3},{id:"E31",track:3,gem:"emerald",cost:{sapphire:7,emerald:3},points:5},{id:"E32",track:3,gem:"emerald",cost:{sapphire:7},points:4},{id:"E33",track:3,gem:"emerald",cost:{diamond:3,sapphire:6,emerald:3},points:4},{id:"E34",track:3,gem:"emerald",cost:{diamond:5,sapphire:3,ruby:3,onyx:3},points:3},{id:"R31",track:3,gem:"ruby",cost:{emerald:7,ruby:3},points:5},{id:"R32",track:3,gem:"ruby",cost:{emerald:7},points:4},{id:"R33",track:3,gem:"ruby",cost:{sapphire:3,emerald:6,ruby:3},points:4},{id:"R34",track:3,gem:"ruby",cost:{diamond:3,sapphire:5,emerald:3,onyx:3},points:3},{id:"D31",track:3,gem:"diamond",cost:{diamond:3,onyx:7},points:5},{id:"D32",track:3,gem:"diamond",cost:{onyx:7},points:4},{id:"D33",track:3,gem:"diamond",cost:{diamond:3,emerald:3,onyx:6},points:4},{id:"D34",track:3,gem:"diamond",cost:{sapphire:3,emerald:3,ruby:5,onyx:3},points:3}],allTiles:[{id:"T1",cost:{diamond:4,sapphire:4},points:3},{id:"T2",cost:{sapphire:4,emerald:4},points:3},{id:"T3",cost:{emerald:4,ruby:4},points:3},{id:"T4",cost:{ruby:4,onyx:4},points:3},{id:"T5",cost:{diamond:4,onyx:4},points:3},{id:"T6",cost:{diamond:3,sapphire:3,emerald:3},points:3},{id:"T7",cost:{sapphire:3,emerald:3,ruby:3},points:3},{id:"T8",cost:{emerald:3,ruby:3,onyx:3},points:3},{id:"T9",cost:{diamond:3,ruby:3,onyx:3},points:3},{id:"T10",cost:{diamond:3,sapphire:3,onyx:3},points:3}]}}]),mainApp.factory("FirebaseFactory",["$firebaseArray","$firebaseObject",function(a,b){"use strict";var c=null;return{getFB:function(a){return c||(c=new Firebase("https://splendid-gems.firebaseio.com/")),a?c.child(a):c},getFBArray:function(b){return a(this.getFB(b))},getFBObject:function(a){return b(this.getFB(a))},getAuth:function(a){return $firebaseAuth(this.getFB(a))},setFB:function(a,b){var c=this.getFB(a);return c.set(b),!1},facebookLogin:function(){var a=this.getFB();return a.authWithOAuthPopup("facebook",function(a,b){a?console.log("Login Failed!",a):console.log("Authenticated successfully with payload:",b)},{scope:"user_friends"}),authData}}}]),mainApp.factory("GemFactory",[function(){"use strict";return{allGems:[{name:"emerald",display:"Emerald",btnClass:"success",color:"green"},{name:"onyx",display:"Onyx",btnClass:"warning",color:"orange"},{name:"ruby",display:"Ruby",btnClass:"danger",color:"red"},{name:"sapphire",display:"Sapphire",btnClass:"primary",color:"blue"},{name:"diamond",display:"Diamond",btnClass:"default",color:"white"},{name:"gold",display:"Gold",btnClass:"gold",color:"yellow"}]}}]),mainApp.factory("MethodFactory",[function(){"use strict";return{}}]);var mc={pluralize:function(a){return a.replace(/y$/,"ie")+"s"},camelToTitle:function(a){return _.capitalize(a.replace(/([A-Z])/g," $1")).trim()},randomDigits:function(a,b){return a=void 0===a?1:a,b=b||999,Math.floor(Math.random()*(b-a+1)+a)},alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),isAngularObjectEqual:function(a,b){return _.isEqual(_.omit(a,"$$hashKey"),_.omit(b,"$$hashKey"))},expandArray:function(a,b){b=b||3;for(var c=[],d=0;b>d;d++)c=c.concat(angular.copy(a));return c},calculateAge:function(a){var b;if(a){var c=Number(a.substr(0,4)),d=Number(a.substr(5,2))-1,e=Number(a.substr(8,2)),f=new Date;b=f.getFullYear()-c,(f.getMonth()<d||f.getMonth()==d&&f.getDate()<e)&&b--}return b||0}};